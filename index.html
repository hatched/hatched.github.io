<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
      <title>From An Egg</title>
      <meta name="twitter:title" content="From An Egg" />
      <meta property="og:title" content="From An Egg" />
    
    <link rel="icon" type="image/png" alt="author's image" href="/images/me.png">
    
      <meta name="description" itemprop="description" content="Jeff Pihach on all things programming.">
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@fromanegg" />
    <meta name="twitter:image" content="https://fromanegg.com/images/me.png" />

    <meta property="og:url" content="https://fromanegg.com/" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="https://fromanegg.com/images/me.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#cc181e">
    <meta name="generator" content="Hugo 0.83.1" />
    <link rel="canonical" href="https://fromanegg.com/"/>
    <link rel="stylesheet" href="/css/normalize-min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/manni.css">
    <link href="/rss" rel="alternate" type="application/rss+xml" title="From An Egg" />
  </head>
  <body>
    <div class="top-bar"></div>

  <nav>
  <img src="/images/me.png"></img>
  <h1 itemprop="author">Jeff Pihach</h1>
  <label for="menu-toggle" class="icon-menu">Menu</label>
  <input type="checkbox" id="menu-toggle"/>
  <div class="nav-wrapper">
    <ul>
      <li class=" active "><a href="/" class="icon-home">Home</a></li>
      <li class=""><a rel="author" href="/about" class="icon-help">About</a></li>
      <li class=""><a href="/posts" class="icon-box">Posts</a></li>
      <li class=""><a href="/projects" class="icon-cubes">Projects</a></li>
      <li class="">
        <label for="tags-toggle">
          <span class="icon-tag">Tags</span>
          <span class="icon-down-dir arrow"></span>
        </label>
        <input type="checkbox" id="tags-toggle"/>
        <ul class="tag-list">
          
          
            <li><a href="/tags/android">android</a></li>
          
            <li><a href="/tags/book-review">book-review</a></li>
          
            <li><a href="/tags/cordova">cordova</a></li>
          
            <li><a href="/tags/css">css</a></li>
          
            <li><a href="/tags/development">development</a></li>
          
            <li><a href="/tags/go">go</a></li>
          
            <li><a href="/tags/hatched-links">hatched-links</a></li>
          
            <li><a href="/tags/html">html</a></li>
          
            <li><a href="/tags/javascript">javascript</a></li>
          
            <li><a href="/tags/juju">juju</a></li>
          
            <li><a href="/tags/juju-gui">juju-gui</a></li>
          
            <li><a href="/tags/linux">linux</a></li>
          
            <li><a href="/tags/node.js">node.js</a></li>
          
            <li><a href="/tags/ops">ops</a></li>
          
            <li><a href="/tags/osx">osx</a></li>
          
            <li><a href="/tags/phonegap">phonegap</a></li>
          
            <li><a href="/tags/python">python</a></li>
          
            <li><a href="/tags/react">react</a></li>
          
            <li><a href="/tags/testing">testing</a></li>
          
            <li><a href="/tags/typescript">typescript</a></li>
          
            <li><a href="/tags/ubuntu">ubuntu</a></li>
          
            <li><a href="/tags/video">video</a></li>
          
            <li><a href="/tags/yui">yui</a></li>
          
        </ul>
      </li>
      <li><a href="https://fromanegg.com/rss.xml" class="icon-rss">RSS</a></li>
    </ul>
    <hr></hr>
    <h3>Social</h3>
    <ul class="social-list">
      <li><a href="https://github.com/hatched" class="icon-github" target="_blank">GitHub</a></li>
      <li><a href="https://twitter.com/fromanegg" class="icon-twitter" target="_blank">Twitter</a></li>
      <li><a href="https://www.youtube.com/channel/UCq2MDZ8IWAV0Jyp6FuwoJXA" class="icon-youtube-play" target="_blank">YouTube</a></li>
      <li><a href="http://stackexchange.com/users/3378894" class="icon-stackoverflow" target="_blank">StackExchange</a></li>
    </ul>
  </div>
</nav>

  
    <section class="article-list">
  <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1><a href="https://fromanegg.com/post/2021/07/27/conditional-data-types-with-typescript/" itemprop="url">Conditional data types with TypeScript</a></h1>
      
        <time pubdate content="2021-07-27 10:00:00 -0600 CST" datetime="2021-07-27 10:00:00 -0600 CST">27 July 2021</time>
      
    </header>
    <p>When dealing with data that&rsquo;s returned from an API you don&rsquo;t always have control over the exact structure which can make it a bit of a challenge to add types to that data with TypeScript to improve the developer experience. I have recently run into this issue when hooking up the <a href="https://github.com/canonical-web-and-design/jaas-dashboard">Juju Dashboard</a> to a new API endpoint that sends deltas every time there is a change in the users environment.</p>
<p>The deltas are sent in the format <code>[DeltaEntity, DeltaType, Delta]</code>, or more specifically <code>[[&quot;application&quot;, &quot;change&quot;, {...}], [&quot;machine&quot;, &quot;remove&quot;, {...}], ...]</code>. The structure of the <code>Delta</code> portion of this tuple is determined by the combination of the <code>DeltaEntity</code> and <code>DeltaType</code> so when dealing with this data you first need to run a conditional over those type values to determine what to do with the <code>Delta</code>. In order to type these we can use a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates">Type Predicate</a> or a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions">Discriminated Union</a>. Ultimately I landed on using a discriminated union but I&rsquo;ll run through both approaches here.</p>
<h4 id="using-a-type-predicate">Using a Type Predicate</h4>
<p>Define the type for the whole delta tuple.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="kr">type</span> <span class="nx">AllWatcherDelta</span> <span class="o">=</span> <span class="p">[</span><span class="nx">DeltaEntity</span><span class="p">,</span> <span class="nx">DeltaType</span><span class="p">,</span> <span class="nx">Delta</span><span class="p">];</span>
</code></pre></div><p>Define the possible values for the entity and type using a union. Yes, even the type predicate approach uses unions as a component of the typing approach. You also want to define the type for each delta type.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="kr">type</span> <span class="nx">DeltaEntity</span> <span class="o">=</span> <span class="s2">&#34;application&#34;</span> <span class="o">|</span> <span class="s2">&#34;charm&#34;</span> <span class="o">|</span> <span class="s2">&#34;unit&#34;</span><span class="p">;</span>
<span class="kr">type</span> <span class="nx">DeltaType</span> <span class="o">=</span> <span class="s2">&#34;change&#34;</span> <span class="o">|</span> <span class="s2">&#34;remove&#34;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">UnitChangeDelta</span> <span class="p">{</span>
  <span class="nx">name</span>: <span class="kt">string</span><span class="p">;</span>
  <span class="nx">ports</span>: <span class="kt">string</span><span class="p">[];</span>
<span class="p">}</span>
</code></pre></div><p>Now we need to create a function that will be used as the predicate in a conditional to determine what the data type is while working on the delta values. These functions will take, at a minimum, the data that you want to define the type for and any additional data you need to determine that type. It must then return a boolean value, if <code>true</code> then <code>change</code> in this function will be of type <code>UnitChangeDelta</code>, otherwise not.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="kd">function</span> <span class="nx">isUnitChangeDelta</span><span class="p">(</span>
  <span class="nx">delta</span>: <span class="kt">AllWatcherDelta</span><span class="p">,</span>
  <span class="nx">change</span>: <span class="kt">Delta</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">change</span> <span class="k">is</span> <span class="nx">UnitChangeDelta</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;unit&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s2">&#34;change&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Using this approach you would then have a string of conditionals checking for the appropriate type and within, would be of the expected type. In this example <code>delta[2]</code>, the actual delta in our tuple will now be properly typed within the conditional as a <code>UnitChangeDelta</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="k">if</span> <span class="p">(</span><span class="nx">isUnitChangeDelta</span><span class="p">(</span><span class="nx">delta</span><span class="p">,</span> <span class="nx">delta</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
  <span class="nx">delta</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">ports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h4 id="using-discriminated-unions">Using Discriminated Unions</h4>
<p>Define all possible tuples of <code>DeltaEntity</code>, <code>DeltaType</code>, and <code>Delta</code> as a discriminated union.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="kr">type</span> <span class="nx">AllWatcherDelta</span> <span class="o">=</span>
  <span class="o">|</span> <span class="p">[</span><span class="s2">&#34;unit&#34;</span><span class="p">,</span> <span class="s2">&#34;change&#34;</span><span class="p">,</span> <span class="nx">UnitChangeDelta</span><span class="p">]</span>
  <span class="o">|</span> <span class="p">[</span><span class="s2">&#34;machine&#34;</span><span class="p">,</span> <span class="s2">&#34;change&#34;</span><span class="p">,</span> <span class="nx">MachineChangeDelta</span><span class="p">]</span>
  <span class="o">|</span> <span class="p">[</span><span class="s2">&#34;application&#34;</span><span class="p">,</span> <span class="s2">&#34;remove&#34;</span><span class="p">,</span> <span class="nx">ApplicationRemoveDelta</span><span class="p">];</span>
</code></pre></div><p>Now when using the delta you need to check the values of each predicate manually and TypeScript will correctly type the data. Here I&rsquo;ve used a <code>switch</code> statement but you could use any type of conditional.</p>
<div class="highlight"><pre class="chroma"><code class="language-TypeScript" data-lang="TypeScript"><span class="k">switch</span> <span class="p">(</span><span class="nx">delta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s2">&#34;unit&#34;</span><span class="o">:</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">delta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&#34;change&#34;</span><span class="o">:</span>
        <span class="nx">delta</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">ports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h4 id="summary">Summary</h4>
<p>Using only a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions">Discriminated Union</a> is great when you have a known set of data that you need to type. As the size or complexity of that data set increases you might want to evaluate using a <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates">Type Predicate</a> as you can execute whatever code you need to determine the type including introspepction into the data itself if you needed to use a canary in the object as the flag.</p>
<p>If either of these approaches don&rsquo;t quite get you there you can also look into adding <a href="https://www.typescriptlang.org/docs/handbook/2/generics.html">Generics</a> into the mix but that&rsquo;ll have to wait for another time.</p>
<p>No matter the approach you take, having properly typed dynamic data dramatically reduces a certain set of errors and increases the productivity of the developer consuming that data so I feel it&rsquo;s worth the investment.</p>
<p>Thanks for reading!</p>

  </article>
</section>

  
    <section class="article-list">
  <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1><a href="https://fromanegg.com/post/2021/06/11/opening-changed-files-in-vscode/" itemprop="url">Opening changed files in VSCode</a></h1>
      
        <time pubdate content="2021-06-11 10:00:00 -0600 CST" datetime="2021-06-11 10:00:00 -0600 CST">11 June 2021</time>
      
    </header>
    <p>A significant portion of my day to day activities are based around code reviews and helping debug issues with other developers. When doing this I will usually open up all of the files that have changed between the current branch and master so that I can get an understanding of the problem as a whole. After a decade of doing this I finally got sick of doing it manually&hellip;There must be a better way! I wanted to check out a branch and open all of the changed files in vscode automatically. After a bit of poking around I found the <code>git diff</code> flag <code>--name-only</code> which returns the list of changed files. The command ended up like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">code -n . <span class="sb">`</span>git --no-pager diff --name-only master<span class="sb">`</span>
</code></pre></div><h4 id="command-breakdown">Command breakdown</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">code -n .
</code></pre></div><p>Opens up a new window of vscode with the current project folder open in the &lsquo;explorer&rsquo; section.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git --no-pager
</code></pre></div><p>disables the pager that git uses by default in zsh (you may not need this flag)</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">--name-only master
</code></pre></div><p>displays a list of files that have changed from master.</p>
<p>Now the next logical step is to make this a bash command and add some customization. Below I&rsquo;ve defined the command as a function with the ability to define an argument for the branch name and another to filter the list of files. I&rsquo;ve found the filter to be especially useful when trying to avoid things like test metadata and lock file updates.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># vscodedevsync [branch] [filter regex]</span>
<span class="k">function</span> vscodedevsync<span class="o">()</span> <span class="o">{</span>
  code -n . <span class="sb">`</span>git --no-pager diff --name-only <span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">master</span><span class="si">}</span> <span class="p">|</span> grep -o <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span><span class="sb">`</span>
<span class="o">}</span>
</code></pre></div><p>Anyways, hope this helps add a bit of efficiency into your day.</p>

  </article>
</section>

  
    <section class="article-list">
  <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1><a href="https://fromanegg.com/post/2020/02/28/use-ubuntu-on-mac-os-with-multipass/" itemprop="url">Use Ubuntu on Mac OS with Multipass</a></h1>
      
        <time pubdate content="2020-02-28 16:28:00 -0600 CST" datetime="2020-02-28 16:28:00 -0600 CST">28 February 2020</time>
      
    </header>
    <p>Running and developing an Ubuntu based workload on Mac OS has never been easier. <a href="https://canonical.com/">Canonical</a> has released a new tool called <a href="https://multipass.run">Multipass</a> which allows you to quickly spin up Ubuntu Server virtual machines on Ubuntu, Mac OS and Windows. The following instructions will get you an Ubuntu Server VM up and running, and the Ubuntu file system mounted to Mac OS so that you can work in the Mac OS UI using your regular development tools like VS Code.</p>
<h4 id="mac-os">Mac OS</h4>
<p>You&rsquo;ll first need to get Multipass installed by visiting the <a href="https://multipass.run">Multipass website</a> and downloading and installing the package on your Mac OS host. Once installed, open the terminal on your Mac OS host and run the following to download and install the latest LTS release of Ubuntu Server.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">multipass launch --name ubuntu
multipass shell ubuntu
</code></pre></div><h4 id="ubuntu">Ubuntu</h4>
<p>After the VM has been started we need to connect to it to install the nfs server.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">sudo apt install nfs-kernel-server -y
</code></pre></div><p>Now we need to create the folder that we’re going to work from in the home directory of our new Ubuntu VM and open up the permissions on it.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">mkdir -p ~/code
sudo chmod -R <span class="m">777</span> ~/code
</code></pre></div><p>This folder needs to be exported from the VM’s file system which is done by appending the following content to the <code>/etc/exports</code> file. If your VM has a different IP range than what is shown below you can simply update the command below to match your environment.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="nb">echo</span> <span class="s2">&#34;/home/ubuntu/code 192.168.64.0/24(rw,fsid=0,insecure,no_subtree_check,all_squash,async,anonuid=1000,anongid=1000)&#34;</span> <span class="p">|</span> sudo tee -a /etc/exports
</code></pre></div><p>Then we have to export the folder and restart the NFS service.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">sudo exportfs -a
sudo service nfs-kernel-server restart
</code></pre></div><p>Create a temporary file so you can see if your mount worked successfully later.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">touch ~/code/test
</code></pre></div><h4 id="mac-os-1">Mac OS</h4>
<p>In another terminal window on your Mac OS host we need to mount our VM’s code folder. Replace the string for the VM’s IP address and the UserName of the user on Mac OS.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">mkdir -p ~/code
sudo mount -t nfs &lt;VM IP&gt;:/home/ubuntu/code /Users/&lt;UserName&gt;/code
</code></pre></div><p>To keep the drive mounted after refreshing and restarting the VM</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash"><span class="nb">echo</span> <span class="s2">&#34;&lt;VM IP&gt;:/home/ubuntu/code /Users/&lt;UserName&gt;/code nfs resvport,rw,rsize=8192,wsize=8192,timeo=14,intr&#34;</span> <span class="p">|</span> sudo tee -a /etc/fstab
</code></pre></div><p>Now you should be able to see the test file that you created previously in Ubuntu from Mac OS.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">ls -al ~/code
</code></pre></div><p>From the terminal on your Mac OS host you can now open these folders like they live in Mac OS with your code editor of choice.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">code ~/code
</code></pre></div><h4 id="tips--tricks">Tips &amp; Tricks</h4>
<p>On a day to day basis the most efficient way to work with these files is to perform your heavy IO interactions like git clones and builds from within your new Ubuntu VM. This can be done by leaving a terminal open SSH&rsquo;d into it.</p>
<p>The services that Multipass use to create the VM on Mac OS allow you to over subscribe the VM&rsquo;s resources so if you want to have the fastest VM possible you can give it all CPU cores and RAM as well as ample disk space. The following command will give the new Ubuntu VM 16 cores, 100GB of disk space and 16GB of ram while allowing the host and other Multipass VM&rsquo;s to share the same resources.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">multipass launch -c <span class="m">16</span> -d 100G -m 16G --name ubuntu
</code></pre></div><p>At the time of writing you cannot resize the VM&rsquo;s disk space so you&rsquo;ll want to give it more than you think you&rsquo;ll need.</p>

  </article>
</section>

  
    <section class="article-list">
  <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1><a href="https://fromanegg.com/post/2020/01/01/testing-your-user-contract/" itemprop="url">Testing your user contract</a></h1>
      
        <time pubdate content="2020-01-01 18:40:00 -0600 CST" datetime="2020-01-01 18:40:00 -0600 CST">1 January 2020</time>
      
    </header>
    <p>Whenever you write any code that is to be consumed by another, whether it be a library or some UI element, that consumer expects it to work in a certain way every time they interact with it. All good developers would agree and that’s why we also write tests that either break our code up into chunks and test that each chunk works as expected, unit tests, or test the entire lifecycle, end to end tests.</p>
<p>Anyone who has written unit tests for long enough knows that they are tedious to keep in sync with refactors and often end up taking a disproportionate amount of time compared to the time it took to write the functional code. I propose that that we focus less on unit tests and replace them with what I’m calling the <strong>user contract</strong> of your code.</p>
<h4 id="what-is-a-user-contract">What is a user contract?</h4>
<p>The consumer expects that when they perform action X, they receive outcome Y. Typically they are not concerned about how X became Y just that it does so reliably. This is what I’m calling the <strong>user contract</strong>. If we as the authors of the code take the same view from a testing perspective, it allows us to write simpler tests and gives us the ability to refactor how a library or UI component works without having to update our tests, dramatically speeding up refactoring.</p>
<p>While these examples are written in Javascript the same techniques apply to all languages.</p>
<h4 id="library-example">Library example</h4>
<p>Starting with a simple library that another developer may be using&hellip;</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">fetchUserList</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">userList</span> <span class="o">=</span> <span class="kr">await</span> <span class="mi">_</span><span class="nx">queryDBForUserList</span><span class="p">();</span>
  <span class="k">return</span> <span class="kr">await</span> <span class="mi">_</span><span class="nx">formatUserList</span><span class="p">(</span><span class="nx">userList</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="mi">_</span><span class="nx">queryDBForUserList</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Fetch content from the database.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">function</span> <span class="mi">_</span><span class="nx">formatuserList</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Reformat the data as returned from the database.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>A consumer of this API would have a couple expectations:</p>
<ul>
<li>That function is asynchronous.</li>
<li>It returns a user list in a specific structure.</li>
</ul>
<p>These expectations then outline what your tests are:</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;fetchUserList&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;does not block&#39;</span><span class="p">);</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;returns in the correct format&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>You should note that we don’t test any method that wasn’t exported, nor do we export methods simply for testing purposes.</p>
<p>To aid the user in understanding what this contract is you can outline it in the docblock for the exported function. This way it can be used to generate the documentation for your library and help outline what your test structure is.</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="cm">/**
</span><span class="cm">  Returns a formatted user list.
</span><span class="cm">  @return {Object} The user list in the following format:
</span><span class="cm">  { id: INT, name: STRING, favouriteColour: STRING }
</span><span class="cm">*/</span>
<span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">fetchUserList</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">userList</span> <span class="o">=</span> <span class="kr">await</span> <span class="mi">_</span><span class="nx">queryDBForUserList</span><span class="p">();</span>
  <span class="k">return</span> <span class="kr">await</span> <span class="mi">_</span><span class="nx">formatUserList</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div><p>We don’t explicitly test the  <code>_queryFBForUSerList</code> and <code>_formatUserList</code> functions as they are implementation details. If you were to change the type of database returning the user list, or the algorithm being used to format the user list you should not have to also modify your tests as the contract to your users has not changed. They still expect that if they call <code>fetchUserList</code> they will receive the list in the specified format.</p>
<h4 id="ui-example">UI Example</h4>
<p>Let’s take a look at a UI component this time using the React javascript library, in an effort to save space I’ve removed the functions that aren’t exported. This also helps to illustrate their irrelevance in our testing strategy.</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">LogIn</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">children</span> <span class="p">})</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">userIsLoggedIn</span> <span class="o">=</span> <span class="nx">useSelector</span><span class="p">(</span><span class="nx">isLoggedIn</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">userIsConnecting</span> <span class="o">=</span> <span class="nx">useSelector</span><span class="p">(</span><span class="nx">isConnecting</span><span class="p">);</span>

  <span class="kr">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="mi">_</span><span class="nx">generateButton</span><span class="p">(</span><span class="nx">userIsConnecting</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userIsLoggedIn</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;&gt;</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&#34;login&#34;</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">className</span><span class="o">=</span><span class="s2">&#34;login__logo&#34;</span> <span class="nx">src</span><span class="o">=</span><span class="p">{</span><span class="nx">logo</span><span class="p">}</span> <span class="nx">alt</span><span class="o">=</span><span class="s2">&#34;logo&#34;</span> <span class="o">/&gt;</span>
          <span class="p">{</span><span class="nx">button</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="err">/div&gt;</span>
        <span class="o">&lt;</span><span class="nx">main</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/main&gt;</span>
      <span class="o">&lt;</span><span class="err">/&gt;</span>
    <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">children</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div><p>This is a fairly simple component that renders a login button with a logo. Let’s go through the exercise and see what our User Contract is:</p>
<ul>
<li>If the user is not logged in
<ul>
<li>It renders a logo and button to log in.</li>
<li>It renders any children passed to it.</li>
<li>clicking the button logs in.</li>
</ul>
</li>
<li>If the user is logged in
<ul>
<li>It does not render a logo and button.</li>
<li>It renders any children passed to it.</li>
</ul>
</li>
</ul>
<p>Our tests would be:</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;LogIn&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;the user is not logged in&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders a logo and button to log in&#39;</span><span class="p">);</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders any children passed to it&#39;</span><span class="p">);</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;clicking the button logs in&#39;</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;the user is logged in&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;does not render a logo and button to log in&#39;</span><span class="p">);</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders any children passed to it&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div><p>Testing the returned value in a UI component is a little more nuanced than checking a return value of a library function. We don’t necessarily want to check every specific detail of each element returned unless it’s part of the contract. I’ll expand these tests with assertions but eschew the component setup and rendering in interest of space.</p>
<div class="highlight"><pre class="chroma"><code class="language-JavaScript" data-lang="JavaScript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders a logo and button to log in&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.login__logo&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.login button&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">);</span>
<span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders any children passed to it&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;main .items&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">it</span><span class="p">(</span><span class="s1">&#39;logs the user in&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.login button&#39;</span><span class="p">).</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">useSelector</span><span class="p">(</span><span class="nx">isLoggedIn</span><span class="p">)).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div><p>It’s important to note here that we have tried to limit the specific details that aren’t relevant to the contract of the component. This allows the design to change and the contract to remain valid and we do not need to update the tests. This is especially beneficial when you have a shared component library within your company. You can update the designs and implementation details of your components without updating the tests.</p>
<h4 id="what-if-i">What if I&hellip;</h4>
<ul>
<li>&hellip;want to test that an api call is being made with the correct signature?
<ul>
<li>You should consider moving this sub api call into its own library and having it tested there. You&rsquo;ll then be testing the <strong>user contract</strong> of this new library, that a call to your api is making a specific call to another api.</li>
</ul>
</li>
<li>&hellip;have to mock out an api call?
<ul>
<li>You’ll find value in implementing a system that mocks out the layer which returns the data. In this layer it’ll return a pre-defined set of data depending on the arguments it receives. This way, if the arguments ever change and become invalid, it’ll no longer return the correctly formatted outcome and your tests will fail.</li>
</ul>
</li>
<li>&hellip;have a complex algorithm that needs testing?
<ul>
<li>Consider moving this to a separate library and test it separately so that the <strong>user contract</strong> of that library is being tested.</li>
</ul>
</li>
<li>&hellip;want to change the contract?
<ul>
<li>You can release a major version bump of your code. See how to use the <a href="https://fromanegg.com/post/2014/04/25/when-to-update-your-semver-version-number/">semver versioning system</a>.</li>
</ul>
</li>
</ul>
<h4 id="conclusion">Conclusion</h4>
<p>When writing the code and exporting methods, ask yourself if the user needs to have access to this method or if you’re only doing it for testing purposes. You can always export more methods, you can’t always take exported methods away.</p>
<p>When writing tests ask yourself how can the consumer interact with your code and what type of outcome is expected for those interactions and them make sure you have those documented and assertions in your tests.</p>
<p>Don&rsquo;t test implementation details of an exported method or UI component. Consider moving those to a different <strong>user contract</strong> if you feel they need direct testing.</p>
<h4 id="more-reading">More reading</h4>
<p>I have written some content many years ago which you may also find helpful:</p>
<ul>
<li><a href="https://fromanegg.com/post/2014/04/25/when-to-update-your-semver-version-number/">When to update your semver version number (2014)</a></li>
<li><a href="https://fromanegg.com/post/2014/03/13/self-documenting-code-is-not-enough/">Self documenting code is not enough (2014)</a></li>
<li><a href="https://fromanegg.com/post/2013/06/07/test-driven-development---the-easy-way/">Test driven development the easy way (2013)</a></li>
</ul>

  </article>
</section>

  
    <section class="article-list">
  <article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1><a href="https://fromanegg.com/post/2017/07/21/eliminating-missing-props-in-react-components/" itemprop="url">Eliminating missing props in React components</a></h1>
      
        <time pubdate content="2017-07-21 10:51:26 -0600 CST" datetime="2017-07-21 10:51:26 -0600 CST">21 July 2017</time>
      
    </header>
    <p>An advantage to components, React or otherwise, is that they can be used multiple times in various contexts across your application. As the application grows and components get modified over time the component call signatures can drift from their original spec and the many call locations across the application can miss getting updated. Compound that with shallow rendering unit tests and you’ve got yourself a problem where parts of your application don’t work as expected because of invalid data being sent to the components, not because the components are broken themselves.</p>
<p>This was an issue that we ran into a few times with the <a href="https://jujucharms.com/new">Juju GUI</a>. The Juju GUI is a web app with a large portion of it rendered using a number of parent React components which then render the appropriate children based on the state of the application.  When one of the children needs access to a method or data, it’s possible that it will need to be passed from the top application down through the parent and various children. This caused issues where it was easy to miss updating a components call signature when it was updated.</p>
<p>To remedy this, <a href="https://twitter.com/frankban_">Francesco Banconi</a>, one of my teammates wrote a <a href="https://github.com/juju/juju-gui/blob/develop/scripts/inspect-components">Python script</a> to analyze all of the components included in the application and their call signatures to ensure that every place it was being called, it was being called with the appropriate props.</p>
<p>We simply added this into our lint target in the Makefile so that CI will fail if a branch attempts to modify the call signatures without updated the rest of the application.</p>
<div class="highlight"><pre class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">lint</span>
<span class="nf">lint</span><span class="o">:</span> <span class="n">lint</span>-<span class="n">python</span> <span class="n">lint</span>-<span class="n">components</span> <span class="n">lint</span>-<span class="n">js</span> <span class="n">lint</span>-<span class="n">css</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">lint</span>-<span class="n">components</span>
<span class="nf">lint-components</span><span class="o">:</span>
	 @./scripts/inspect-components validate --path jujugui/static/gui/src/ --short
</code></pre></div><p>The GUI is over 150k lines of code without dependencies and the script takes less than 300ms to run and outputs errors similar to the following allowing you to track them down quickly.</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">EntityContent:
  instantiated at: /juju-gui/jujugui/static/gui/src/app/components/entity-details/entity-details.js:98
  defined at: /juju-gui/jujugui/static/gui/src/app/components/entity-details/content/content.js:21
  entityModel provided but not declared

component validation failed: <span class="m">1</span> error found
</code></pre></div><p>We have found this hugely helpful to reduce errors in the shipped application with almost no overhead during development. Should we split this out into its own tool? Would you find this helpful in your own projects? Let me know <a href="https://twitter.com/fromanegg">@fromanegg</a> Thanks for reading.</p>

  </article>
</section>

  
  
<ul class="pagination">
  <li class="page-item">
    <a href="/" class="page-link" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
  </li>
  <li class="page-item disabled">
    <a  class="page-link" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
  </li>
  <li class="page-item active">
    <a class="page-link" href="/">1</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="/page/2/">2</a>
  </li>
  <li class="page-item">
    <a class="page-link" href="/page/3/">3</a>
  </li>
  <li class="page-item disabled">
    <span aria-hidden="true">&nbsp;&hellip;&nbsp;</span>
  </li>
  <li class="page-item">
    <a class="page-link" href="/page/15/">15</a>
  </li>
  <li class="page-item">
    <a href="/page/2/" class="page-link" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
  </li>
  <li class="page-item">
    <a href="/page/15/" class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
  </li>
</ul>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28934249-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>

