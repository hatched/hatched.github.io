<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <title>Easy testing of code involving native methods in JavaScript &middot; From An Egg</title>
  
  <link rel="icon" type="image/png" href="http://fromanegg.com/img/me.png">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#cc181e">
  <meta name="generator" content="Hugo 0.17" />
  <link rel="stylesheet" href="http://fromanegg.com/css/normalize-min.css">
  <link rel="stylesheet" href="http://fromanegg.com/css/styles.css">
  <link rel="stylesheet" href="http://fromanegg.com/css/manni.css">
  <link href="" rel="alternate" type="application/rss+xml" title="From An Egg" />
</head>
<div class="top-bar"></div>

<body>
  <nav>
  <img src="http://fromanegg.com/img/me.png"></img>
  <h1>Jeff Pihach</h1>
  <ul>
    <li class=""><a href="/" class="icon-home">Home</a></li>
    <li class=""><a href="/about" class="icon-help">About</a></li>
    <li class=""><a href="/posts" class="icon-box">Posts</a></li>
    <li class=""><a href="/projects" class="icon-cubes">Projects</a></li>
    <li class="">
      <label for="tags-toggle">
        <span class="icon-tag">Tags</span>
        <span class="icon-down-dir arrow"></span>
      </label>
      <input type="checkbox" id="tags-toggle"/>
      <ul class="tag-list">
        
        
          <li><a href="/tags/android">android (1)</a></li>
        
          <li><a href="/tags/book-review">book-review (1)</a></li>
        
          <li><a href="/tags/cordova">cordova (2)</a></li>
        
          <li><a href="/tags/css">css (6)</a></li>
        
          <li><a href="/tags/development">development (7)</a></li>
        
          <li><a href="/tags/go">go (1)</a></li>
        
          <li><a href="/tags/hatched-links">hatched-links (5)</a></li>
        
          <li><a href="/tags/javascript">javascript (16)</a></li>
        
          <li><a href="/tags/juju">juju (17)</a></li>
        
          <li><a href="/tags/juju-gui">juju-gui (11)</a></li>
        
          <li><a href="/tags/linux">linux (1)</a></li>
        
          <li><a href="/tags/node.js">node.js (1)</a></li>
        
          <li><a href="/tags/ops">ops (2)</a></li>
        
          <li><a href="/tags/osx">osx (1)</a></li>
        
          <li><a href="/tags/phonegap">phonegap (2)</a></li>
        
          <li><a href="/tags/testing">testing (1)</a></li>
        
          <li><a href="/tags/ubuntu">ubuntu (2)</a></li>
        
          <li><a href="/tags/video">video (2)</a></li>
        
          <li><a href="/tags/yui">yui (11)</a></li>
        
      </ul>
    </li>
    <li><a href="/rss" class="icon-rss">RSS</a></li>
  </ul>
  <hr></hr>
  <h3>Social</h3>
  <ul>
    <li><a href="https://github.com/hatched" class="icon-github" target="_blank">GitHub</a></li>
    <li><a href="https://twitter.com/fromanegg" class="icon-twitter" target="_blank">Twitter</a></li>
    <li><a href="https://www.youtube.com/channel/UCq2MDZ8IWAV0Jyp6FuwoJXA" class="icon-youtube-play" target="_blank">YouTube</a></li>
    <li><a href="https://plus.google.com/+JeffPihach" class="icon-google" target="_blank">Google</a></li>
    <li><a href="http://stackexchange.com/users/3378894/hatch?tab=top" class="icon-stackoverflow" target="_blank">StackExchange</a></li>
  </ul>
</nav>

  <section class="article-list">
  <article>
    <header>
      <h1><a href="http://fromanegg.com/post/2015/04/22/easy-testing-of-code-involving-native-methods-in-javascript">Easy testing of code involving native methods in JavaScript</a></h1>
      
        <time datetime="2015-04-22 19:57:00 -0600 CST">22 April 2015</time>
      
    </header>
    <p>When using ‘use strict;’ in your scripts you’ll find that you are no longer allowed to overwrite native methods like FileReader() so how do you test that these methods are being called with the appropriate parameters? Lets start with a typical function call involving FileReader() and then modify it to make it easier to test.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">importFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">processData</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Pre &lsquo;use strict’; days you could simply stub out the global FileReader() but since that’s no longer an option we need to get a little creative with our code structure. First thing we’re going to do is create a FileReader instance generator function.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">importFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">generateFileReader</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">processData</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">generateFileReader</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>Then we’ll move the onload callback to a named function.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="kd">function</span> <span class="nx">importFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">generateFileReader</span><span class="p">();</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">_readerOnloadHandler</span><span class="p">;</span>
  <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">generateFileReader</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">_readerOnloadHandler</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">processData</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>Now you can test the importFile function and its parts by stubbing out the generateFileReader function to return a basic reader stub and not have to worry about the native method. In the following example I’m using two simple stubbing methods to generate stub functions and methods.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;parses files&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Set up the stubs.</span>
    <span class="kd">var</span> <span class="nx">processStub</span> <span class="o">=</span> <span class="nx">stubMethod</span><span class="p">(</span><span class="s1">&#39;processData&#39;</span><span class="p">);</span>
    <span class="c1">// The second parameter of the stubMethod is what generateFileReader</span>
    <span class="c1">// will return when it&#39;s called.</span>
    <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">stubMethod</span><span class="p">(</span><span class="s1">&#39;generateFileReader&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">onload</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">readAsText</span><span class="o">:</span> <span class="nx">stubFunction</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="c1">// Call the public method.</span>
    <span class="nx">importFile</span><span class="p">(</span><span class="s1">&#39;/path/to/file&#39;</span><span class="p">);</span>
    <span class="c1">// Make assertions</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">reader</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">.</span><span class="nx">lastArguments</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/path/to/file&#39;</span><span class="p">);</span>
    <span class="c1">// Call the callback.</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span><span class="p">({</span> <span class="nx">target</span><span class="o">:</span> <span class="p">{</span> <span class="nx">result</span><span class="o">:</span> <span class="s1">&#39;file data&#39;</span> <span class="p">}});</span>
    <span class="c1">// Make assertions</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">processStub</span><span class="p">.</span><span class="nx">calledOnce</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">processStub</span><span class="p">.</span><span class="nx">lastArguments</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;file data&#39;</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div>

<p>Splitting up the code in this way makes unit testing possible because you are essentially wrapping the native function call in a function which are you are able to stub out. Happy testing!</p>

  </article>
</section>

  <section class="article-list tags-list">
  <article>
    
    <ul class="icon-tag">
      
        <li><a href="/tags/javascript">javascript</a></li>
      
    </ul>
    
  </article>
</section>

  
    <div id="disqus_thread"></div>
<script>
    

    var disqus_config = function () {
        
          var identifier = "/post/117133402942/easy-testing-of-code-involving-native-methods-in";
          this.page.url = this.page.identifier = 'http://fromanegg.com/post/' + identifier.split('/')[2];
        
    };
    (function() {
        var d = document, s = d.createElement('script');
        s.async = true;
        s.src = '//fromanegg.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28934249-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
